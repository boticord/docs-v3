---
title: Уведомления
description: Получение уведомлений о любых действиях с ботом на BotiCord
---

# Уведомления  {#head}

Получать уведомления о действиях с ботом на BotiCord можно двумя способами: WebSocket и HTTPs WebHooks. Далее про них:

## WebSocket

[WebSocket](https://ru.wikipedia.org/wiki/WebSocket) это базовый способ для получения уведомлений о действиях с ботами.

### Как подключиться {#connect}

Кратко:

1. `wss://gateway.boticord.top/websocket/`;
2. client hello: `{"event":"auth","data":{"token":"token from boticord user settings"}}`;
3. server hello: `{"event":"hello","data":{"id":"connection id"}}`;
4. server notification:

```json
{
  "event": "notify",
  "data": {
    "type": number
    event
    types,
    "payload": any
    json
    data
    or
    null,
    "affected": string
    affected
    resource
    id,
    "user": string
    id
    of
    the
    user
    who
    triggered
    this
    notification,
    "happened": number
    unix
    timestamp
    ms
  }
}
```

Подробно:

1. Вашей программе (далее: клиент) необходимо установить соединение по пути `wss://gateway.boticord.top/websocket/`;
2. Клиент должен отправить сообщение в виде валидного JSON: `{"event":"auth","data":{"token":"..."}}`. В поле `token`
   необходимо вписать токен, который можно получить в настройках в профиле владельца бота на
   мониторинге. `https://boticord.top/me` в настройках, чуть ниже, необходимо сгенерировать токен.
3. После того как клиент отошлёт сообщение серверу, сервер должен
   ответить: `{"event":"hello","data":{"id":"специальный айди вашего клиента (не бота и не сервер)"}`
4. Если сервер не ответил или ответил чем-то другим, попробуйте позже или исправьте ошибку, о которой вам сообщил
   сервер (обычно, указан неверный токен или он вовсе отсутствует)
5. Сервер будет отправлять уведомления в следующем формате:

```json
{
  "event": "notify",
  "data": {
    "type": число, один из типов событий, см. NotifyTypes,
    "payload": любые дополнительные данные в JSON (например, содержание комментария), или null,
    "affected": строка, айди ресурса, о котором происходит слбытие, например, айди комментария,
    "user": строка, айди пользователя, что спровоцировал это уведомление,
    "happened": число, метка времени UNIX в миллисекундах, когда произошло событие
  }
}
```

#### Как происходят отключения {#disconnect}

Если токен в настройках профиля владельца бота на ботикорде был удалён или перегенерирован, сервер оборвёт соединение WebSocket с кодом
выхода `1006`. В любых других случаях отключения по желанию сервера не предусмотрены, однако клиент может безопасно
отключится в любой момент. Если соединение пропало, ваш клиент должен попытаться подключиться заново, соблюдая
глобальный рейт-лимит 15 попыток в 10 сек, до тех пор, пока соединение не установится снова, затем нужно повторить
авторизацию.

## HTTPs WebHooks

Также BotiCord может отправлять вам уведомления по HTTPs, делая запросы POST на указанный вами адрес.

### Подготовка вашего сервера {#config}

Кратко:

1. Откройте порт 80 для http или 443 для https, для подсети `2a06:98c0::/29` (AS132892 - Cloudflare, Inc);
2. Проверьте, работает ли IPV6;
3. Принимайте POST запросы на указанном в настройках бота на ботикорде (вкладка API) адресе;
4. Проверяйте правильность запросов с помощью токена из настроек бота, который мы передаём в хеадерах.

Подробно:

1. BotiCord использует [IPV6](https://habr.com/ru/company/droider/blog/568778/) адреса подсети `2a06:98c0::/29` (
   AS132892 - Cloudflare, Inc) для отправки уведомлений. Это значит, что любые IPV4 адреса **не подходят**. Вы не
   сможете получать уведомления если попытаетесь сделать это по прямому IPV4. Это включает в себя, например, ваши пк и
   IPV4 выданные вашим провайдером для доступа в Интернет, а также, облачные сервера поставляемые с IPV4. Если у вас
   есть облачный сервер, значит у вас скорее всего есть домен или возможность подключения к брокеру туннелей, и если вы
   используете Cloudflare для своего домена, просто создайте поддомен или transform rule или выделите отдельный endpoint
   в вашем API, если оно есть.
2. Вам необходимо создать сервер, который сможет принимать наши POST запросы и работать 24/7. Также ваш сервер должен
   отвечать со статусом 200, если всё прошло хорошо. Ваш сервер не должен быть слишком медленным, иначе уведомление не
   дойдёт. Попытка отправки любого конкретного уведомления с нашей стороны производится ровно 1 раз. Если ваш сервер не
   смог получить уведомление, оно уйдёт в небытие (только если вы не используете получение уведомлений по WebSocket
   параллельно, уведомления дублируются и там и там).
3. Мы добавили настройки дополнительных хеадеров для добавления в наши POST запросы к вашим серверам. Вы можете
   использовать их, например, чтобы авторизовать наш сервер
   в [Cloudflare Access](https://www.cloudflare.com/products/zero-trust/access/). Вы можете также установить специальные
   хеадеры с уникальными значениями, чтобы проверять, что запрос пришёл от нас. По-умолчанию мы рассчитываем, что вы
   будете проверять правильность запроса по токену, который мы передаём вместе с запросом в хеадере `X-Boticord-Token`.
4. **Мы не рекомендуем использовать HTTP вместо HTTPS для сервера, который принимает уведомления.** Если вы используете
   Cloudflare, пожалуйста, убедитесь что соединение между Cloudflare и вашим сервером защищено и проходит через 443
   HTTPS. **Мы передаём токен из настроек бота на BotiCord хеадере `X-Boticord-Token` в качестве подтверждения, что
   запрос пришёл от
   нас. *Этот токен используется не только для уведомлений, но также для изменений вашего бота на BotiCord.***
   Отнеситесь серьёзно к обеспечению безопасности.
5. Необходимо открыть порт 80 для http или 443 для https, для подсети `2a06:98c0::/29`. Вы можете проверять, проходят ли
   запросы от нас, используя специальную кнопку в настройках. Она будет отсылать POST запрос на указанный адрес с
   тестовым уведомлением.
6. Принимайте запросы и проверяйте их правильность с помощью токена из настроек бота на BotiCord, он приходит вместе с
   уведомлением:
   хеадеры:

```txt
Content-Type: application/json
X-Boticord-Token: токен из настроек бота
X-Boticord-Affected: айди ресурса, о котором происходит событие, например, айди комментария
...ваши хеадеры
```

## NotifyTypes
### Общая структура уведомлений
```json
{
   "type": "тип уведомления",
   "payload": {},
   "id": "айди бота/сервера",
   "user": "айди человека, что спровоцировал уведомление",
   "happened": 1688322825141,
   "webhookSettings": {
      "enabled": true,
      "headers": {
         "Custom-Header": "кастомные хедеры (они также будут в хедерах запроса) или пустой объект"
      },
      "url": "ссылка, куда был отправлен запрос, или NULL",
      "token": "токен из настроек API владельца бота/сервера"
   }
}
```
`payload` - это объект, который содержит в себе дополнительные данные, которые могут пригодиться для обработки уведомления.

`happened` это метка времени UNIX в миллисекундах, когда произошло событие.

**BotiCord может присылать и другие уведомления, не перечисленные здесь.**

### Добавление апа
Тип: `up_added`
Payload:
```json
{
   "upCount": 1
}
```
`upCount` приходит с учётом умножителя за бусты.

### Новый отзыв
Тип: `comment_added`
Payload:
```json
{
   "content": "контент отзыва",
   "rating": 5
}
```
`rating` - это оценка отзыва от 1 до 5.

### Изменение отзыва
Тип: `comment_edited`
Payload:
```json
{
   "content": "контент отзыва",
   "rating": 3
}
```
`rating` - это оценка отзыва от 1 до 5.
Контент/Рейтинг старого отзыва не отправляются.

### Удаление отзыва
Тип: `comment_removed`
Payload:
```json
{
   "content": "контент отзыва",
   "rating": 3
}
```
`rating` - это оценка отзыва от 1 до 5.


